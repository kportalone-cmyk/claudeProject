<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{{APP_TITLE}} - 관리자 대시보드</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
:root{--bg:#f5f6fa;--card:#fff;--sidebar:#fff;--border:#eef0f6;--tx:#1a1d2e;--tx2:#6b7280;--tx3:#9ca3af;--blue:#4f6ef7;--blue-light:#eef2ff;--cyan:#06b6d4;--green:#22c55e;--green-light:#ecfdf5;--amber:#f59e0b;--amber-light:#fffbeb;--red:#ef4444;--red-light:#fef2f2;--purple:#8b5cf6;--shadow:0 2px 8px rgba(0,0,0,.04);--radius:16px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter','Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx);line-height:1.6;font-size:13px;display:flex;height:100vh;overflow:hidden}

/* ===== SIDEBAR ===== */
.sidebar{width:220px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;padding:20px 0}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:0 20px 24px;border-bottom:1px solid var(--border);margin-bottom:8px}
.sidebar-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),#818cf8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:14px}
.sidebar-logo-text{font-size:14px;font-weight:700;color:var(--tx)}
.sidebar-logo-sub{font-size:9px;color:var(--tx3);margin-top:1px}
.sidebar-nav{flex:1;padding:8px 12px}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:10px;cursor:pointer;transition:all .15s;color:var(--tx2);font-size:12px;font-weight:500;margin-bottom:2px}
.nav-item:hover{background:#f5f6fa;color:var(--tx)}
.nav-item.active{background:var(--blue-light);color:var(--blue);font-weight:600}
.nav-item .material-icons-outlined{font-size:20px}
.nav-item .nav-badge{margin-left:auto;background:var(--blue);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px}
.sidebar-footer{padding:12px 16px;border-top:1px solid var(--border);margin-top:8px}
.sidebar-footer a{display:flex;align-items:center;gap:8px;color:var(--tx3);font-size:11px;text-decoration:none;padding:6px 8px;border-radius:6px;transition:all .15s}
.sidebar-footer a:hover{color:var(--blue);background:var(--blue-light)}

/* ===== MAIN ===== */
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden}
.main-scroll{flex:1;overflow-y:auto;padding:24px 28px}

/* Header bar */
.top-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.greeting h1{font-size:22px;font-weight:800;color:var(--tx);margin-bottom:2px}
.greeting p{font-size:12px;color:var(--tx3)}
.top-actions{display:flex;align-items:center;gap:8px}
.top-date{font-size:12px;color:var(--tx2);font-weight:500;display:flex;align-items:center;gap:4px}
.top-date .material-icons-outlined{font-size:16px}

/* Period + Range */
.filter-bar{display:flex;align-items:center;gap:8px;margin-bottom:18px;flex-wrap:wrap}
.period-tabs{display:flex;gap:2px;background:#eef0f6;border-radius:10px;padding:3px}
.period-btn{padding:6px 14px;border-radius:8px;font-size:11px;font-weight:600;border:none;cursor:pointer;transition:all .15s;color:var(--tx2);background:transparent}
.period-btn.active{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(79,110,247,.25)}
.period-btn:not(.active):hover{background:#e2e8f0}
.year-select{padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;color:var(--tx2);background:var(--card);cursor:pointer}
.icon-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:8px;background:var(--card);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;color:var(--tx3);transition:all .15s}
.icon-btn:hover{background:var(--blue-light);color:var(--blue);border-color:var(--blue)}

/* Range Picker */
.range-picker-wrap{position:relative;display:inline-flex}
.range-btn{padding:6px 14px;border:1px solid var(--border);border-radius:8px;font-size:11px;font-weight:600;color:var(--tx2);background:var(--card);cursor:pointer;display:flex;align-items:center;gap:5px;transition:all .15s;white-space:nowrap}
.range-btn:hover{border-color:var(--blue);color:var(--blue)}
.range-btn.has-range{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}
.range-clear{margin-left:4px;cursor:pointer;font-size:12px;color:var(--blue);font-weight:700}
.range-dropdown{position:absolute;top:100%;right:0;margin-top:6px;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,.12);z-index:30;padding:20px;display:none;width:600px}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.cal-nav{background:none;border:none;cursor:pointer;color:var(--tx2);font-size:16px;padding:4px 8px;border-radius:6px;transition:background .12s}
.cal-nav:hover{background:var(--blue-light);color:var(--blue)}
.cal-title{font-size:13px;font-weight:700;color:var(--tx)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;text-align:center}
.cal-dow{font-size:9px;font-weight:700;color:var(--tx3);padding:6px 0}
.cal-day{font-size:11px;padding:7px 2px;cursor:pointer;border-radius:8px;transition:all .1s;color:var(--tx)}
.cal-day:hover{background:var(--blue-light)}
.cal-day.other-month{color:#d1d5db}
.cal-day.today{font-weight:700;color:var(--blue);background:var(--blue-light)}
.cal-day.in-range{background:#e8edff;border-radius:0}
.cal-day.range-start{background:var(--blue);color:#fff;border-radius:8px 0 0 8px}
.cal-day.range-end{background:var(--blue);color:#fff;border-radius:0 8px 8px 0}
.cal-day.range-start.range-end{border-radius:8px}
.cal-day.hover-end{background:rgba(79,110,247,.2);border-radius:8px}
.cal-months{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.cal-apply{margin-top:12px;display:flex;justify-content:flex-end;gap:8px}
.cal-apply button{padding:7px 18px;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .12s}
.cal-apply .apply-btn{background:var(--blue);color:#fff}.cal-apply .apply-btn:hover{background:#4059d8}
.cal-apply .clear-btn{background:#eef0f6;color:var(--tx2)}.cal-apply .clear-btn:hover{background:#e2e8f0}

/* ===== STAT CARDS ===== */
.stat-row{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.stat-card{flex:1;min-width:140px;background:var(--card);border-radius:var(--radius);padding:18px 20px;border:1px solid var(--border);box-shadow:var(--shadow);display:flex;align-items:center;gap:14px;transition:all .2s}
.stat-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.07);transform:translateY(-2px)}
.stat-card-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.stat-card-icon .material-icons-outlined{font-size:22px}
.stat-card-info .stat-label{font-size:11px;color:var(--tx3);font-weight:500;margin-bottom:2px}
.stat-card-info .stat-value{font-size:22px;font-weight:800;color:var(--tx);letter-spacing:-.5px}
.stat-card-info .stat-sub{font-size:10px;margin-top:1px}
.stat-sub .up{color:var(--green)}.stat-sub .down{color:var(--red)}

/* ===== CHART CARDS ===== */
.chart-row{display:grid;gap:16px;margin-bottom:16px}
.chart-row-2{grid-template-columns:1fr 1fr}
.chart-row-3{grid-template-columns:1fr 2fr}
.chart-row-r{grid-template-columns:2fr 1fr}
@media(max-width:960px){.chart-row-2,.chart-row-3,.chart-row-r{grid-template-columns:1fr}}
.card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px solid var(--border);box-shadow:var(--shadow)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.card-title{font-size:14px;font-weight:700;color:var(--tx)}
.card-badge{font-size:10px;font-weight:600;padding:3px 10px;border-radius:20px}
.chart-canvas{position:relative;width:100%;height:260px}

/* ===== TABLE ===== */
.data-table{width:100%;border-collapse:separate;border-spacing:0 4px;font-size:11px}
.data-table thead th{text-align:left;padding:8px 10px;font-weight:600;color:var(--tx3);font-size:10px;text-transform:uppercase;letter-spacing:.5px}
.data-table thead th.r{text-align:right}
.data-table tbody tr{background:var(--card);border-radius:10px;cursor:pointer;transition:all .1s}
.data-table tbody tr:hover{background:var(--blue-light)}
.data-table td{padding:10px;vertical-align:middle}
.data-table td:first-child{border-radius:10px 0 0 10px}
.data-table td:last-child{border-radius:0 10px 10px 0}
.data-table td.r{text-align:right}
.user-avatar{width:32px;height:32px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:12px;font-weight:700;margin-right:8px;vertical-align:middle}
.av-1{background:linear-gradient(135deg,#6366f1,#818cf8)}
.av-2{background:linear-gradient(135deg,#06b6d4,#22d3ee)}
.av-3{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
.user-name{font-weight:600;color:var(--tx);font-size:12px}
.user-id{font-size:9px;color:var(--tx3)}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:600}
.badge-blue{background:var(--blue-light);color:var(--blue)}
.badge-green{background:var(--green-light);color:var(--green)}
.badge-amber{background:var(--amber-light);color:#b45309}
.badge-red{background:var(--red-light);color:var(--red)}
.rank-medal{display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;color:#fff;font-size:9px;font-weight:700}
.rank-1{background:linear-gradient(135deg,#fbbf24,#f59e0b)}.rank-2{background:linear-gradient(135deg,#9ca3af,#6b7280)}.rank-3{background:linear-gradient(135deg,#d97706,#b45309)}
.progress-bar{height:4px;background:#eef0f6;border-radius:2px;overflow:hidden;width:80px}
.progress-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--blue),#818cf8)}
.scroll-box{max-height:380px;overflow-y:auto}

/* ===== FEATURES ===== */
.feat-legend{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:10px}
.feat-item{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--tx2);padding:6px 8px;background:#f8f9fc;border-radius:8px}
.feat-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.feat-count{margin-left:auto;font-weight:700;color:var(--tx)}

/* ===== SEARCH ===== */
.search-box{position:relative;margin-bottom:16px}
.search-input{width:100%;padding:12px 14px 12px 40px;border:1px solid var(--border);border-radius:12px;font-size:13px;font-family:inherit;background:var(--card);transition:all .2s}
.search-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 4px rgba(79,110,247,.1)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--tx3);font-size:18px}
.search-results{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 16px 48px rgba(0,0,0,.12);z-index:20;max-height:280px;overflow-y:auto;display:none;margin-top:4px}
.search-item{display:flex;align-items:center;gap:10px;padding:10px 14px;cursor:pointer;transition:all .1s;border-bottom:1px solid #fafbfc}
.search-item:hover,.search-item.search-active{background:var(--blue-light)}
.search-item:last-child{border:none}
.search-empty{padding:20px;text-align:center;color:var(--tx3);font-size:12px}

/* ===== USER DETAIL ===== */
.ud-header{display:flex;align-items:center;gap:16px;margin-bottom:18px;padding:20px;background:var(--card);border-radius:var(--radius);border:1px solid var(--border)}
.ud-avatar{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#a78bfa);display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;font-weight:700;flex-shrink:0}
.ud-info h2{font-size:18px;font-weight:800;margin-bottom:2px}
.ud-info p{font-size:12px;color:var(--tx3)}
.ud-back{display:inline-flex;align-items:center;gap:4px;font-size:12px;color:var(--blue);cursor:pointer;font-weight:600;margin-bottom:12px;padding:4px 0}
.ud-back:hover{text-decoration:underline}

/* Storage */
.storage-bar{height:6px;background:#eef0f6;border-radius:3px;overflow:hidden}
.storage-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--cyan))}

/* Loading */
.dash-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh}
.spin{width:32px;height:32px;border:3px solid #e0e7ff;border-top-color:var(--blue);border-radius:50%;animation:sp .7s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.spin-text{margin-top:10px;font-size:12px;color:var(--tx3)}
.tab-page{display:none}.tab-page.active{display:block}
.dash-footer{text-align:center;font-size:10px;color:var(--tx3);padding:20px 0}

/* ===== TOKEN TAB ===== */
.token-model-legend{display:flex;gap:16px;margin-top:8px;justify-content:center;flex-wrap:wrap}
.token-model-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--tx2)}
.token-model-dot{width:10px;height:10px;border-radius:50%}
.cost-value{font-size:18px;font-weight:800;color:var(--tx)}
.cost-value .currency{font-size:11px;font-weight:500;color:var(--tx3);margin-right:2px}
.model-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:9px;font-weight:700}
.model-opus{background:#f0e6ff;color:#7c3aed}
.model-sonnet{background:#e0f7fa;color:#0891b2}
</style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">{{APP_BRAND_ICON}}</div>
    <div><div class="sidebar-logo-text">{{APP_TITLE}}</div><div class="sidebar-logo-sub">Admin Dashboard</div></div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-item active" data-tab="overview"><span class="material-icons-outlined">dashboard</span> 전체 현황</div>
    <div class="nav-item" data-tab="users"><span class="material-icons-outlined">person_search</span> 사용자 검색</div>
    <div class="nav-item" data-tab="storage"><span class="material-icons-outlined">folder_open</span> 파일/스토리지</div>
    <div class="nav-item" data-tab="tokens"><span class="material-icons-outlined">token</span> 토큰 사용량</div>
  </nav>
  <div class="sidebar-footer">
    <a href="javascript:void(0)" id="sidebar-refresh"><span class="material-icons-outlined" style="font-size:16px">refresh</span> 새로고침</a>
    <a href="javascript:history.back()"><span class="material-icons-outlined" style="font-size:16px">arrow_back</span> 메인으로</a>
  </div>
</aside>

<!-- ===== MAIN AREA ===== -->
<div class="main-area">
<div class="main-scroll">
  <div class="dash-loading" id="dash-loading"><div class="spin"></div><div class="spin-text">대시보드 로딩 중...</div></div>
  <div id="dash-content" style="display:none">

    <!-- TAB: OVERVIEW -->
    <div class="tab-page active" id="page-overview">
      <div class="top-bar">
        <div class="greeting"><h1 id="greeting-text">관리자 대시보드</h1><p>시스템 사용량을 한눈에 확인하세요</p></div>
        <div class="top-actions">
          <span class="top-date"><span class="material-icons-outlined">calendar_today</span> <span id="today-date"></span></span>
          <button class="icon-btn" id="btn-refresh" title="새로고침"><span class="material-icons-outlined" style="font-size:16px">refresh</span></button>
        </div>
      </div>
      <div class="filter-bar">
        <div class="period-tabs" id="period-tabs"><button class="period-btn" data-p="today">오늘</button><button class="period-btn" data-p="week">이번 주</button><button class="period-btn active" data-p="month">이번 달</button><button class="period-btn" data-p="year">올해</button></div>
        <select class="year-select" id="year-select"></select>
        <div class="range-picker-wrap" id="overview-range-wrap"><button class="range-btn" id="overview-range-btn"><span class="material-icons-outlined" style="font-size:15px">date_range</span> <span class="range-label">기간 선택</span></button><div class="range-dropdown" id="overview-range-dd"></div></div>
      </div>
      <div class="stat-row" id="stat-grid"></div>
      <div class="chart-row chart-row-r">
        <div class="card"><div class="card-header"><span class="card-title">Performance</span><span class="card-badge badge-blue" id="daily-range"></span></div><div class="chart-canvas"><canvas id="chart-daily"></canvas></div></div>
        <div class="card"><div class="card-header"><span class="card-title">기능별 사용 비율</span><span class="card-badge badge-green" id="feat-period-label"></span></div><div class="chart-canvas" style="height:180px"><canvas id="chart-features"></canvas></div><div class="feat-legend" id="feat-legend"></div></div>
      </div>
      <div class="chart-row chart-row-2" style="margin-top:16px">
        <div class="card"><div class="card-header"><span class="card-title">월별 현황</span><span class="card-badge badge-blue" id="monthly-label"></span></div><div class="chart-canvas"><canvas id="chart-monthly"></canvas></div></div>
        <div class="card">
          <div class="card-header"><span class="card-title">사용자 랭킹</span><span class="card-badge badge-blue" id="user-count-badge">Top 50</span></div>
          <div class="scroll-box"><table class="data-table"><thead><tr><th style="width:32px">#</th><th>사용자</th><th>ID</th><th class="r">대화</th><th class="r">활동</th></tr></thead><tbody id="user-tbody"></tbody></table></div>
        </div>
      </div>
    </div>

    <!-- TAB: USERS -->
    <div class="tab-page" id="page-users">
      <div id="user-search-panel">
        <div class="top-bar"><div class="greeting"><h1>사용자 검색</h1><p>이름 또는 ID로 사용자를 검색하고 상세 분석을 확인하세요</p></div></div>
        <div class="search-box"><span class="material-icons-outlined search-icon">search</span><input type="text" class="search-input" id="user-search-input" placeholder="이름 또는 ID 입력..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="dash-user-search-x"><div class="search-results" id="search-results"></div></div>
        <div id="search-hint" style="text-align:center;padding:60px 20px;color:var(--tx3)"><span class="material-icons-outlined" style="font-size:56px;color:#e0e4ee;display:block;margin-bottom:12px">person_search</span><p style="font-size:14px;font-weight:600;margin-bottom:4px">사용자를 검색하세요</p><p style="font-size:11px">이름 또는 ID를 입력하면 상세 분석을 확인할 수 있습니다</p></div>
      </div>
      <div id="user-detail-panel" style="display:none">
        <div class="ud-back" id="ud-back"><span class="material-icons-outlined" style="font-size:16px">arrow_back</span> 검색으로 돌아가기</div>
        <div class="filter-bar" id="ud-filters">
          <div class="period-tabs" id="ud-period-tabs"><button class="period-btn" data-p="today">오늘</button><button class="period-btn" data-p="week">이번 주</button><button class="period-btn active" data-p="month">이번 달</button><button class="period-btn" data-p="year">올해</button></div>
          <div class="range-picker-wrap" id="ud-range-wrap"><button class="range-btn" id="ud-range-btn"><span class="material-icons-outlined" style="font-size:15px">date_range</span> <span class="range-label">기간 선택</span></button><div class="range-dropdown" id="ud-range-dd"></div></div>
        </div>
        <div class="ud-header" id="ud-header"></div>
        <div class="stat-row" id="ud-stats"></div>
        <div class="chart-row chart-row-2"><div class="card"><div class="card-header"><span class="card-title">일별 대화 추이</span><span class="card-badge badge-blue" id="ud-daily-range"></span></div><div class="chart-canvas"><canvas id="chart-ud-daily"></canvas></div></div><div class="card"><div class="card-header"><span class="card-title">월별 대화 현황</span><span class="card-badge badge-blue" id="ud-monthly-label"></span></div><div class="chart-canvas"><canvas id="chart-ud-monthly"></canvas></div></div></div>
        <div class="card" style="margin-top:16px"><div class="card-header"><span class="card-title">파일 사용량</span></div><div id="ud-file-stats"></div></div>
      </div>
    </div>

    <!-- TAB: STORAGE -->
    <div class="tab-page" id="page-storage"></div>

    <!-- TAB: TOKENS -->
    <div class="tab-page" id="page-tokens">
      <div class="top-bar">
        <div class="greeting"><h1>토큰 사용량</h1><p>AI 모델별, 사용자별 토큰 소비 및 비용을 분석합니다</p></div>
        <div class="top-actions">
          <span class="top-date"><span class="material-icons-outlined">calendar_today</span> <span id="token-today-date"></span></span>
          <button class="icon-btn" id="btn-token-refresh" title="새로고침"><span class="material-icons-outlined" style="font-size:16px">refresh</span></button>
        </div>
      </div>
      <div class="filter-bar">
        <div class="period-tabs" id="token-period-tabs"><button class="period-btn" data-p="today">오늘</button><button class="period-btn" data-p="week">이번 주</button><button class="period-btn active" data-p="month">이번 달</button><button class="period-btn" data-p="year">올해</button></div>
        <select class="year-select" id="token-year-select"></select>
        <div class="range-picker-wrap" id="token-range-wrap"><button class="range-btn" id="token-range-btn"><span class="material-icons-outlined" style="font-size:15px">date_range</span> <span class="range-label">기간 선택</span></button><div class="range-dropdown" id="token-range-dd"></div></div>
      </div>
      <div class="stat-row" id="token-stat-grid"></div>
      <div class="chart-row chart-row-r">
        <div class="card"><div class="card-header"><span class="card-title">일별 토큰 사용 추이</span><span class="card-badge badge-blue" id="token-daily-range"></span></div><div class="chart-canvas"><canvas id="chart-token-daily"></canvas></div></div>
        <div class="card"><div class="card-header"><span class="card-title">모델별 비율</span><span class="card-badge badge-green" id="token-model-period-label"></span></div><div class="chart-canvas" style="height:180px"><canvas id="chart-token-model"></canvas></div><div class="token-model-legend" id="token-model-legend"></div></div>
      </div>
      <div class="chart-row chart-row-2" style="margin-top:16px">
        <div class="card"><div class="card-header"><span class="card-title">월별 토큰 사용량</span><span class="card-badge badge-blue" id="token-monthly-label"></span></div><div class="chart-canvas"><canvas id="chart-token-monthly"></canvas></div></div>
        <div class="card"><div class="card-header"><span class="card-title">서비스별 사용량</span><span class="card-badge badge-green" id="token-service-label"></span></div><div class="chart-canvas" style="height:180px"><canvas id="chart-token-service"></canvas></div><div class="feat-legend" id="token-service-legend"></div></div>
      </div>
      <div class="card" style="margin-top:16px">
        <div class="card-header"><span class="card-title">사용자별 토큰 사용량</span><span class="card-badge badge-blue" id="token-user-count-badge">Top 50</span></div>
        <div class="scroll-box" style="max-height:480px"><table class="data-table"><thead><tr><th style="width:32px">#</th><th>사용자</th><th>ID</th><th class="r">입력 토큰</th><th class="r">출력 토큰</th><th class="r">총 토큰</th><th class="r">Opus</th><th class="r">Sonnet</th><th class="r">비용(USD)</th></tr></thead><tbody id="token-user-tbody"></tbody></table></div>
      </div>
    </div>

    <div class="dash-footer">{{APP_TITLE}} Administration Dashboard</div>
  </div>
</div>
</div>

<script>
var BASE='{{BASE_URL}}',CI={},COLORS=['#4f6ef7','#06b6d4','#22c55e','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6'];
var currentPeriod='month',currentYear=new Date().getFullYear(),searchTimer=null,searchIdx=-1;
var overviewRange={start:null,end:null},udRange={start:null,end:null},tokenRange={start:null,end:null},udUsername='';
var tokenPeriod='month',tokenYear=new Date().getFullYear();
var AV=['av-1','av-2','av-3'];
function api(p){return $.getJSON(BASE+p)}
function esc(s){return $('<span>').text(s).html()}
function num(n){return(n||0).toLocaleString()}
function fmtDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function fmtDateKr(d){return(d.getMonth()+1)+'월 '+d.getDate()+'일'}
function makeChart(id,cfg){if(CI[id])CI[id].destroy();CI[id]=new Chart(document.getElementById(id).getContext('2d'),cfg)}
function chartOpts(){return{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'top',labels:{usePointStyle:true,pointStyle:'circle',padding:16,font:{size:10,weight:'600'},color:'#6b7280'}}},scales:{x:{grid:{display:false},ticks:{font:{size:9},color:'#9ca3af',maxTicksLimit:12}},y:{grid:{color:'#f0f1f5',lineWidth:1},ticks:{font:{size:9},color:'#9ca3af'},beginAtZero:true}}}}
function dateParams(range){return range.start&&range.end?'&start_date='+fmtDate(range.start)+'&end_date='+fmtDate(range.end):''}
function periodToRange(period){var now=new Date(),s,e=new Date(now.getFullYear(),now.getMonth(),now.getDate());if(period==='today')s=new Date(e);else if(period==='week'){s=new Date(e);s.setDate(s.getDate()-6)}else if(period==='month')s=new Date(now.getFullYear(),now.getMonth(),1);else if(period==='year')s=new Date(now.getFullYear(),0,1);else s=new Date(now.getFullYear(),now.getMonth(),1);return{start:s,end:e}}

// =========== RANGE CALENDAR ===========
function RangePicker(wrapId,onApply){
    var self=this;this.wrap=$('#'+wrapId);this.dd=this.wrap.find('.range-dropdown');this.btn=this.wrap.find('.range-btn');this.onApply=onApply;
    this.start=null;this.end=null;this.selecting='start';this.viewMonth=new Date().getMonth();this.viewYear=new Date().getFullYear();
    this.btn.on('click',function(e){e.stopPropagation();self.dd.is(':visible')?self.dd.hide():(self.render(),self.dd.show())});
    this.dd.on('click',function(e){e.stopPropagation()});
    $(document).on('click',function(e){if(!$(e.target).closest('#'+wrapId).length)self.dd.hide()});
}
RangePicker.prototype.render=function(){
    var self=this,m1=this.viewMonth,y1=this.viewYear,m2=m1+1,y2=y1;if(m2>11){m2=0;y2++}
    var st='';
    if(this.start&&!this.end)st='<div style="text-align:center;font-size:11px;color:var(--blue);font-weight:600;padding:8px;background:var(--blue-light);border-radius:8px;margin-bottom:10px">시작일: '+fmtDateKr(this.start)+' — 종료일을 선택하세요</div>';
    else if(this.start&&this.end)st='<div style="text-align:center;font-size:11px;color:var(--blue);font-weight:600;padding:8px;background:var(--blue-light);border-radius:8px;margin-bottom:10px">'+fmtDateKr(this.start)+' ~ '+fmtDateKr(this.end)+' ('+Math.round((this.end-this.start)/86400000+1)+'일)</div>';
    else st='<div style="text-align:center;font-size:11px;color:var(--tx3);padding:8px;margin-bottom:10px">시작일을 선택하세요</div>';
    var h='<div class="cal-header"><button class="cal-nav" data-dir="prev">◀</button><span class="cal-title">'+y1+'년 '+(m1+1)+'월 — '+y2+'년 '+(m2+1)+'월</span><button class="cal-nav" data-dir="next">▶</button></div>'+st;
    h+='<div class="cal-months"><div>'+this.renderMonth(y1,m1)+'</div><div>'+this.renderMonth(y2,m2)+'</div></div>';
    h+='<div class="cal-apply"><button class="clear-btn cal-action" data-act="clear">초기화</button><button class="apply-btn cal-action" data-act="apply"'+(this.start&&this.end?'':' disabled style="opacity:.4;cursor:default"')+'>적용</button></div>';
    this.dd.html(h);
    this.dd.off('click.cal').on('click.cal','.cal-nav',function(e){e.stopPropagation();if($(this).data('dir')==='prev'){self.viewMonth--;if(self.viewMonth<0){self.viewMonth=11;self.viewYear--}}else{self.viewMonth++;if(self.viewMonth>11){self.viewMonth=0;self.viewYear++}}self.render()})
    .on('click.cal','.cal-day[data-d]',function(e){e.stopPropagation();var d=new Date($(this).data('d'));if(self.selecting==='start'){self.start=d;self.end=null;self.selecting='end'}else{if(d>=self.start){self.end=d}else{self.end=self.start;self.start=d}self.selecting='start'}self.render()})
    .on('click.cal','.cal-action',function(e){e.stopPropagation();if($(this).data('act')==='clear'){self.start=null;self.end=null;self.selecting='start';self.updateBtn();self.render();self.onApply(null,null)}else if($(this).data('act')==='apply'&&self.start&&self.end){self.dd.hide();self.updateBtn();self.onApply(self.start,self.end)}});
    this.dd.off('mouseenter.cal');
    if(this.start&&!this.end){this.dd.on('mouseenter.cal','.cal-day[data-d]',function(){var hd=new Date($(this).data('d'));self.dd.find('.cal-day[data-d]').each(function(){var cd=new Date($(this).data('d'));$(this).removeClass('in-range hover-end');if(hd>=self.start){if(cd>self.start&&cd<hd)$(this).addClass('in-range');if(cd.getTime()===hd.getTime())$(this).addClass('hover-end')}else{if(cd<self.start&&cd>hd)$(this).addClass('in-range');if(cd.getTime()===hd.getTime())$(this).addClass('hover-end')}})})}
};
RangePicker.prototype.renderMonth=function(y,m){var dows=['일','월','화','수','목','금','토'];var h='<div class="cal-grid">';dows.forEach(function(d){h+='<div class="cal-dow">'+d+'</div>'});var first=new Date(y,m,1),last=new Date(y,m+1,0),sd=first.getDay(),today=new Date();today.setHours(0,0,0,0);for(var i=0;i<sd;i++){var pd=new Date(y,m,-sd+i+1);h+=this.dayCell(pd,true)}for(var d=1;d<=last.getDate();d++)h+=this.dayCell(new Date(y,m,d),false);var rem=7-(sd+last.getDate())%7;if(rem<7)for(var i=1;i<=rem;i++)h+=this.dayCell(new Date(y,m+1,i),true);h+='</div>';return h};
RangePicker.prototype.dayCell=function(dt,om){var c='cal-day',today=new Date();today.setHours(0,0,0,0);if(om)c+=' other-month';if(dt.getTime()===today.getTime())c+=' today';if(this.start&&this.end){var t=dt.getTime();if(t===this.start.getTime())c+=' range-start';if(t===this.end.getTime())c+=' range-end';if(t>this.start.getTime()&&t<this.end.getTime())c+=' in-range'}else if(this.start&&dt.getTime()===this.start.getTime())c+=' range-start range-end';return'<div class="'+c+'" data-d="'+fmtDate(dt)+'">'+dt.getDate()+'</div>'};
RangePicker.prototype.updateBtn=function(){if(this.start&&this.end){this.btn.addClass('has-range');this.btn.find('.range-label').html(fmtDateKr(this.start)+' ~ '+fmtDateKr(this.end)+' <span class="range-clear" onclick="event.stopPropagation()">✕</span>');var self=this;this.btn.find('.range-clear').on('click',function(){self.start=null;self.end=null;self.updateBtn();self.onApply(null,null)})}else{this.btn.removeClass('has-range');this.btn.find('.range-label').text('기간 선택')}};
RangePicker.prototype.setRange=function(s,e){this.start=s;this.end=e;this.updateBtn()};

// =========== INIT ===========
var overviewPicker,udPicker,tokenPicker;
$(function(){
    $('#today-date').text(new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric',weekday:'long'}));
    var $ys=$('#year-select');for(var y=2024;y<=2028;y++)$ys.append('<option value="'+y+'"'+(y===currentYear?' selected':'')+'>'+y+'년</option>');
    $ys.on('change',function(){currentYear=+$(this).val();loadOverview()});
    $('#period-tabs').on('click','.period-btn',function(){currentPeriod=$(this).data('p');$('#period-tabs .period-btn').removeClass('active');$(this).addClass('active');overviewRange={start:null,end:null};overviewPicker.setRange(null,null);loadOverview()});
    // Sidebar nav
    $('.nav-item').on('click',function(){var tab=$(this).data('tab');$('.nav-item').removeClass('active');$(this).addClass('active');$('.tab-page').removeClass('active');$('#page-'+tab).addClass('active');if(tab==='storage')loadStorage();else if(tab==='tokens')loadTokens()});
    $('#btn-refresh,#sidebar-refresh').on('click',function(){var a=$('.nav-item.active').data('tab');if(a==='overview')loadOverview();else if(a==='storage')loadStorage();else if(a==='tokens')loadTokens();else if(a==='users'&&udUsername)loadUserDetail(udUsername)});
    // Search with keyboard
    $('#user-search-input').on('input',function(){clearTimeout(searchTimer);searchIdx=-1;var q=$(this).val().trim();if(q.length<1){$('#search-results').hide();return}searchTimer=setTimeout(function(){searchUsers(q)},300)}).on('focus',function(){if($('#search-results .search-item').length)$('#search-results').show()}).on('keydown',function(e){
        var $it=$('#search-results .search-item');if(!$it.length||!$('#search-results').is(':visible'))return;
        if(e.key==='ArrowDown'||e.keyCode===40){e.preventDefault();searchIdx=Math.min(searchIdx+1,$it.length-1);$it.removeClass('search-active');$it.eq(searchIdx).addClass('search-active');$it.eq(searchIdx)[0].scrollIntoView({block:'nearest'})}
        else if(e.key==='ArrowUp'||e.keyCode===38){e.preventDefault();searchIdx=Math.max(searchIdx-1,0);$it.removeClass('search-active');$it.eq(searchIdx).addClass('search-active');$it.eq(searchIdx)[0].scrollIntoView({block:'nearest'})}
        else if(e.key==='Enter'||e.keyCode===13){e.preventDefault();if(searchIdx>=0&&searchIdx<$it.length)$it.eq(searchIdx).trigger('click');else if($it.length===1)$it.eq(0).trigger('click')}
        else if(e.key==='Escape'||e.keyCode===27){$('#search-results').hide();searchIdx=-1}
    });
    $(document).on('mouseenter','.search-item',function(){searchIdx=$(this).index();$('.search-item').removeClass('search-active');$(this).addClass('search-active')});
    $(document).on('click',function(e){if(!$(e.target).closest('.search-box').length)$('#search-results').hide()});
    $('#ud-back').on('click',function(){$('#user-detail-panel').hide();$('#user-search-panel').show()});
    $('#ud-period-tabs').on('click','.period-btn',function(){$('#ud-period-tabs .period-btn').removeClass('active');$(this).addClass('active');udRange={start:null,end:null};udPicker.setRange(null,null);if(udUsername)loadUserDetail(udUsername)});
    overviewPicker=new RangePicker('overview-range-wrap',function(s,e){overviewRange.start=s;overviewRange.end=e;if(s&&e)$('#period-tabs .period-btn').removeClass('active');loadOverview()});
    udPicker=new RangePicker('ud-range-wrap',function(s,e){udRange.start=s;udRange.end=e;if(s&&e)$('#ud-period-tabs .period-btn').removeClass('active');if(udUsername)loadUserDetail(udUsername)});
    tokenPicker=new RangePicker('token-range-wrap',function(s,e){tokenRange.start=s;tokenRange.end=e;if(s&&e)$('#token-period-tabs .period-btn').removeClass('active');loadTokens()});
    $('#token-period-tabs').on('click','.period-btn',function(){tokenPeriod=$(this).data('p');$('#token-period-tabs .period-btn').removeClass('active');$(this).addClass('active');tokenRange={start:null,end:null};tokenPicker.setRange(null,null);loadTokens()});
    var $tys=$('#token-year-select');for(var y=2024;y<=2028;y++)$tys.append('<option value="'+y+'"'+(y===tokenYear?' selected':'')+'>'+y+'년</option>');
    $tys.on('change',function(){tokenYear=+$(this).val();loadTokens()});
    $('#btn-token-refresh').on('click',function(){loadTokens()});
    loadOverview();
});

// =========== OVERVIEW ===========
function loadOverview(){
    $('#dash-loading').show();$('#dash-content').hide();var dp;
    if(overviewRange.start&&overviewRange.end)dp=dateParams(overviewRange);else{var pr=periodToRange(currentPeriod);dp='&start_date='+fmtDate(pr.start)+'&end_date='+fmtDate(pr.end)}
    var pp='&period='+currentPeriod;
    $.when(api('/api/admin/dashboard/summary?_=1'+dp),api('/api/admin/dashboard/daily?days=30'+dp),api('/api/admin/dashboard/monthly?year='+currentYear),api('/api/admin/dashboard/users?_=1'+pp+dp),api('/api/admin/dashboard/features?_=1'+pp+dp)
    ).then(function(s,d,m,u,f){renderSummary(s[0]);renderDailyChart(d[0].days||[]);renderMonthlyChart(m[0].months||[],currentYear);renderFeaturesChart(f[0].features||[]);renderUsersTable(u[0].users||[]);$('#dash-loading').hide();$('#dash-content').show()
    }).fail(function(){$('#dash-loading').html('<div style="text-align:center;padding:40px"><span class="material-icons-outlined" style="font-size:48px;color:var(--red)">error_outline</span><p style="margin-top:10px;font-size:13px;color:var(--tx2)">데이터 로드 실패</p><button onclick="loadOverview()" style="margin-top:10px;padding:8px 24px;background:var(--blue);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px">다시 시도</button></div>')})}
function renderSummary(s){
    var pLabel=overviewRange.start?fmtDateKr(overviewRange.start)+' ~ '+fmtDateKr(overviewRange.end):($('#period-tabs .period-btn.active').text()||'이번 달');
    var cards=[
        {icon:'group',label:'전체 사용자',value:s.total_users,sub:'오늘 <span class="up">▲ '+num(s.today_users)+'</span>',iconBg:'var(--blue-light)',iconColor:'var(--blue)'},
        {icon:'chat_bubble_outline',label:'전체 대화',value:s.total_chats,sub:'오늘 <span class="up">▲ '+num(s.today_chats)+'</span>',iconBg:'var(--green-light)',iconColor:'var(--green)'},
        {icon:'date_range',label:pLabel,value:s.range_chats,sub:'사용자 '+num(s.range_users)+'명',iconBg:'var(--amber-light)',iconColor:'var(--amber)'},
        {icon:'bolt',label:'AI 작업',value:s.total_tasks,sub:'오늘 <span class="up">▲ '+num(s.today_tasks)+'</span>',iconBg:'var(--red-light)',iconColor:'var(--red)'},
        {icon:'folder',label:'프로젝트',value:s.total_projects,sub:'',iconBg:'#f0e6ff',iconColor:'var(--purple)'},
        {icon:'psychology',label:'스킬',value:s.total_skills,sub:'',iconBg:'#e0f7fa',iconColor:'var(--cyan)'}
    ];
    var h='';cards.forEach(function(c){h+='<div class="stat-card"><div class="stat-card-icon" style="background:'+c.iconBg+';color:'+c.iconColor+'"><span class="material-icons-outlined">'+c.icon+'</span></div><div class="stat-card-info"><div class="stat-label">'+c.label+'</div><div class="stat-value">'+num(c.value)+'</div>'+(c.sub?'<div class="stat-sub">'+c.sub+'</div>':'')+'</div></div>'});
    $('#stat-grid').html(h)}
function renderDailyChart(days){if(!days.length)return;$('#daily-range').text(days[0].date+' ~ '+days[days.length-1].date);makeChart('chart-daily',{type:'line',data:{labels:days.map(function(d){return d.date}),datasets:[{label:'대화',data:days.map(function(d){return d.chats}),borderColor:'#4f6ef7',backgroundColor:'rgba(79,110,247,0.06)',fill:true,tension:.4,borderWidth:2.5,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:'#4f6ef7'},{label:'사용자',data:days.map(function(d){return d.users}),borderColor:'#f59e0b',backgroundColor:'transparent',fill:false,tension:.4,borderWidth:2,borderDash:[4,4],pointRadius:0,pointHoverRadius:4}]},options:chartOpts()})}
function renderMonthlyChart(months,year){$('#monthly-label').text(year+'년');makeChart('chart-monthly',{type:'bar',data:{labels:months.map(function(m){return m.month+'월'}),datasets:[{label:'대화',data:months.map(function(m){return m.chats}),backgroundColor:'#4f6ef7',borderRadius:6,maxBarThickness:20},{label:'작업',data:months.map(function(m){return m.tasks}),backgroundColor:'#06b6d4',borderRadius:6,maxBarThickness:20},{label:'사용자',data:months.map(function(m){return m.users}),backgroundColor:'#22c55e',borderRadius:6,maxBarThickness:20}]},options:chartOpts()})}
function renderFeaturesChart(features){var pl={today:'오늘',week:'이번 주',month:'이번 달',year:'올해'};$('#feat-period-label').text(overviewRange.start?fmtDateKr(overviewRange.start)+'~'+fmtDateKr(overviewRange.end):(pl[currentPeriod]||''));if(!features.length){$('#feat-legend').html('<div style="text-align:center;padding:30px;color:var(--tx3);font-size:11px">데이터 없음</div>');return}makeChart('chart-features',{type:'doughnut',data:{labels:features.map(function(f){return f.name}),datasets:[{data:features.map(function(f){return f.count}),backgroundColor:COLORS.slice(0,features.length),borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{display:false}}}});var lh='';features.forEach(function(f,i){lh+='<div class="feat-item"><div class="feat-dot" style="background:'+COLORS[i%COLORS.length]+'"></div><span>'+esc(f.name)+'</span><span class="feat-count">'+num(f.count)+'</span></div>'});$('#feat-legend').html(lh)}
function renderUsersTable(users){$('#user-count-badge').text('Top '+users.length);if(!users.length){$('#user-tbody').html('<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--tx3)">데이터 없음</td></tr>');return}var max=users[0].chat_count||1,h='';users.forEach(function(u,i){var pct=Math.round((u.chat_count/max)*100);var rk=i<3?'<span class="rank-medal rank-'+(i+1)+'">'+(i+1)+'</span>':'<span style="color:var(--tx3);font-size:10px">'+(i+1)+'</span>';var la=u.last_active?new Date(u.last_active).toLocaleDateString('ko-KR',{month:'short',day:'numeric'}):'-';h+='<tr onclick="selectUser(\''+esc(u.username)+'\')"><td>'+rk+'</td><td><div style="display:flex;align-items:center"><span class="user-avatar '+AV[i%3]+'">'+esc((u.display_name||'?').charAt(0))+'</span><div><div class="user-name">'+esc(u.display_name)+'</div><div class="progress-bar"><div class="progress-fill" style="width:'+pct+'%"></div></div></div></div></td><td><span class="user-id">'+esc(u.username)+'</span></td><td class="r"><span class="badge badge-blue">'+num(u.chat_count)+'</span></td><td class="r" style="font-size:10px;color:var(--tx3)">'+la+'</td></tr>'});$('#user-tbody').html(h)}

// =========== USERS ===========
function searchUsers(q){api('/api/admin/dashboard/search-users?q='+encodeURIComponent(q)).then(function(d){var $r=$('#search-results');$r.empty();searchIdx=-1;if(!d.users||!d.users.length){$r.html('<div class="search-empty">검색 결과 없음</div>').show();return}d.users.forEach(function(u,i){$r.append('<div class="search-item" onclick="selectUser(\''+esc(u.username)+'\')"><span class="user-avatar '+AV[i%3]+'" style="width:34px;height:34px;font-size:12px">'+esc((u.name||u.username||'?').charAt(0))+'</span><div><div style="font-weight:600;font-size:12px">'+esc(u.name||u.username)+'</div><div style="font-size:10px;color:var(--tx3)">'+esc(u.username)+(u.dept?' · '+esc(u.dept):'')+'</div></div></div>')});$r.show()})}
function selectUser(username){$('#search-results').hide();udUsername=username;$('.nav-item').removeClass('active');$('.nav-item[data-tab="users"]').addClass('active');$('.tab-page').removeClass('active');$('#page-users').addClass('active');$('#user-search-panel').hide();$('#user-detail-panel').show();loadUserDetail(username)}
function loadUserDetail(username){
    var dp;if(udRange.start&&udRange.end)dp=dateParams(udRange);else{var pp=$('#ud-period-tabs .period-btn.active').data('p')||'month';var pr=periodToRange(pp);dp='&start_date='+fmtDate(pr.start)+'&end_date='+fmtDate(pr.end)}
    var periodLabel=$('#ud-period-tabs .period-btn.active').text()||'이번 달';if(udRange.start)periodLabel=fmtDateKr(udRange.start)+' ~ '+fmtDateKr(udRange.end);
    $('#ud-header').html('<div style="text-align:center;padding:20px;width:100%"><div class="spin" style="margin:0 auto"></div></div>');$('#ud-stats').empty();
    api('/api/admin/dashboard/user-detail?username='+encodeURIComponent(username)+dp).then(function(d){
        var u=d.user,s=d.stats;
        $('#ud-header').html('<div class="ud-avatar">'+esc((u.name||'?').charAt(0))+'</div><div class="ud-info"><h2>'+esc(u.name)+'</h2><p>'+esc(u.username)+(u.dept?' · '+esc(u.dept):'')+(u.role?' · <span class="badge badge-amber">'+esc(u.role)+'</span>':'')+'</p></div><div style="margin-left:auto;text-align:right"><div style="font-size:10px;color:var(--tx3)">첫 사용</div><div style="font-size:13px;font-weight:700">'+(s.first_chat?new Date(s.first_chat).toLocaleDateString('ko-KR'):'-')+'</div></div>');
        var sc=[
            {icon:'chat_bubble_outline',label:'전체 대화',value:s.total_chats,iconBg:'var(--blue-light)',iconColor:'var(--blue)'},
            {icon:'today',label:'오늘',value:s.today_chats,iconBg:'var(--green-light)',iconColor:'var(--green)'},
            {icon:'date_range',label:periodLabel,value:s.range_chats,iconBg:'var(--amber-light)',iconColor:'var(--amber)'},
            {icon:'folder',label:'프로젝트',value:s.project_count,iconBg:'#f0e6ff',iconColor:'var(--purple)'}
        ];
        var sh='';sc.forEach(function(c){sh+='<div class="stat-card"><div class="stat-card-icon" style="background:'+c.iconBg+';color:'+c.iconColor+'"><span class="material-icons-outlined">'+c.icon+'</span></div><div class="stat-card-info"><div class="stat-label">'+c.label+'</div><div class="stat-value">'+num(c.value)+'</div></div></div>'});$('#ud-stats').html(sh);
        var days=d.daily||[];if(days.length){$('#ud-daily-range').text(days[0].date+' ~ '+days[days.length-1].date);makeChart('chart-ud-daily',{type:'line',data:{labels:days.map(function(x){return x.date}),datasets:[{label:'대화',data:days.map(function(x){return x.chats}),borderColor:'#4f6ef7',backgroundColor:'rgba(79,110,247,0.08)',fill:true,tension:.4,borderWidth:2.5,pointRadius:0}]},options:chartOpts()})}
        var months=d.monthly||[];$('#ud-monthly-label').text(new Date().getFullYear()+'년');makeChart('chart-ud-monthly',{type:'bar',data:{labels:months.map(function(x){return x.month+'월'}),datasets:[{label:'대화',data:months.map(function(x){return x.chats}),backgroundColor:'#4f6ef7',borderRadius:6,maxBarThickness:20}]},options:chartOpts()});
        var fs=d.file_stats;$('#ud-file-stats').html('<div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;padding:4px 0"><div><span style="font-size:11px;color:var(--tx3)">파일 수</span><div style="font-size:22px;font-weight:800">'+num(fs.total_files)+'<span style="font-size:12px;color:var(--tx3);font-weight:500"> 개</span></div></div><div><span style="font-size:11px;color:var(--tx3)">전체 용량</span><div style="font-size:22px;font-weight:800">'+esc(fs.total_size_fmt)+'</div></div><div style="flex:1;min-width:180px"><span style="font-size:11px;color:var(--tx3)">마지막 활동</span><div style="font-size:14px;font-weight:600">'+(s.last_chat?new Date(s.last_chat).toLocaleString('ko-KR'):'-')+'</div></div></div>')})}

// =========== STORAGE ===========
function loadStorage(){$('#page-storage').html('<div class="dash-loading" style="height:260px"><div class="spin"></div><div class="spin-text">스토리지 분석 중...</div></div>');api('/api/admin/dashboard/storage').then(function(d){
    var h='<div class="top-bar"><div class="greeting"><h1>파일/스토리지</h1><p>사용자별 파일 사용량을 확인합니다</p></div></div>';
    h+='<div class="stat-row">';
    h+='<div class="stat-card"><div class="stat-card-icon" style="background:var(--blue-light);color:var(--blue)"><span class="material-icons-outlined">storage</span></div><div class="stat-card-info"><div class="stat-label">전체 용량</div><div class="stat-value">'+esc(d.total_size_fmt)+'</div></div></div>';
    h+='<div class="stat-card"><div class="stat-card-icon" style="background:var(--green-light);color:var(--green)"><span class="material-icons-outlined">description</span></div><div class="stat-card-info"><div class="stat-label">전체 파일</div><div class="stat-value">'+num(d.total_files)+'</div></div></div>';
    h+='<div class="stat-card"><div class="stat-card-icon" style="background:var(--amber-light);color:var(--amber)"><span class="material-icons-outlined">people</span></div><div class="stat-card-info"><div class="stat-label">사용자</div><div class="stat-value">'+num(d.users.length)+'</div></div></div></div>';
    h+='<div class="card"><div class="card-header"><span class="card-title">사용자별 스토리지</span><span class="card-badge badge-blue">'+d.users.length+'명</span></div><div class="scroll-box" style="max-height:480px"><table class="data-table"><thead><tr><th style="width:32px">#</th><th>사용자</th><th>ID</th><th class="r">파일</th><th class="r">용량</th><th style="width:140px">비율</th></tr></thead><tbody>';
    var mx=d.users.length?d.users[0].size:1;d.users.forEach(function(u,i){var pct=mx>0?Math.round((u.size/mx)*100):0;var tp=d.total_size>0?(u.size/d.total_size*100).toFixed(1):'0';var rk=i<3?'<span class="rank-medal rank-'+(i+1)+'">'+(i+1)+'</span>':'<span style="color:var(--tx3);font-size:10px">'+(i+1)+'</span>';
    h+='<tr onclick="selectUser(\''+esc(u.username)+'\')"><td>'+rk+'</td><td><div style="display:flex;align-items:center"><span class="user-avatar '+AV[i%3]+'">'+esc((u.display_name||'?').charAt(0))+'</span><span class="user-name">'+esc(u.display_name)+'</span></div></td><td><span class="user-id">'+esc(u.username)+'</span></td><td class="r"><span class="badge badge-blue">'+num(u.files)+'</span></td><td class="r" style="font-weight:600;font-size:11px">'+esc(u.size_fmt)+'</td><td><div style="display:flex;align-items:center;gap:6px"><div class="storage-bar" style="flex:1"><div class="storage-fill" style="width:'+pct+'%"></div></div><span style="font-size:9px;color:var(--tx3);width:32px;text-align:right">'+tp+'%</span></div></td></tr>'});
    h+='</tbody></table></div></div>';$('#page-storage').html(h)}).fail(function(){$('#page-storage').html('<div style="text-align:center;padding:60px;color:var(--tx3);font-size:13px">스토리지 정보를 불러올 수 없습니다</div>')})}

// =========== TOKEN USAGE ===========
function fmtTokens(n){if(n>=1000000)return(n/1000000).toFixed(1)+'M';if(n>=1000)return(n/1000).toFixed(1)+'K';return(n||0).toString()}
function fmtCost(n){return'$'+(n||0).toFixed(2)}
function loadTokens(){
    var dp;
    if(tokenRange.start&&tokenRange.end)dp=dateParams(tokenRange);else{var pr=periodToRange(tokenPeriod);dp='&start_date='+fmtDate(pr.start)+'&end_date='+fmtDate(pr.end)}
    $('#token-today-date').text(new Date().toLocaleDateString('ko-KR',{year:'numeric',month:'long',day:'numeric'}));
    var pl={today:'오늘',week:'이번 주',month:'이번 달',year:'올해'};
    var periodLabel=tokenRange.start?fmtDateKr(tokenRange.start)+'~'+fmtDateKr(tokenRange.end):(pl[tokenPeriod]||'이번 달');
    $('#token-model-period-label').text(periodLabel);$('#token-service-label').text(periodLabel);
    $.when(
        api('/api/admin/dashboard/token-summary?_=1'+dp),
        api('/api/admin/dashboard/token-daily?days=30'+dp),
        api('/api/admin/dashboard/token-monthly?year='+tokenYear),
        api('/api/admin/dashboard/token-by-model?_=1'+dp),
        api('/api/admin/dashboard/token-by-user?_=1&period='+tokenPeriod+dp),
        api('/api/admin/dashboard/token-by-service?_=1'+dp)
    ).then(function(s,d,m,md,u,sv){
        renderTokenSummary(s[0],periodLabel);
        renderTokenDailyChart(d[0].days||[]);
        renderTokenMonthlyChart(m[0].months||[],tokenYear);
        renderTokenModelChart(md[0].models||[]);
        renderTokenUsersTable(u[0].users||[]);
        renderTokenServiceChart(sv[0].services||[]);
    }).fail(function(){$('#token-stat-grid').html('<div style="text-align:center;padding:40px;color:var(--red);width:100%"><span class="material-icons-outlined" style="font-size:36px">error_outline</span><p style="margin-top:8px;font-size:12px">데이터 로드 실패</p></div>')})}
function renderTokenSummary(s,periodLabel){
    var cards=[
        {icon:'toll',label:'총 토큰',value:fmtTokens(s.total_tokens),sub:'오늘 '+fmtTokens(s.today_tokens),iconBg:'var(--blue-light)',iconColor:'var(--blue)'},
        {icon:'input',label:periodLabel+' 입력',value:fmtTokens(s.range_input_tokens),sub:'',iconBg:'var(--green-light)',iconColor:'var(--green)'},
        {icon:'output',label:periodLabel+' 출력',value:fmtTokens(s.range_output_tokens),sub:'',iconBg:'var(--amber-light)',iconColor:'var(--amber)'},
        {icon:'api',label:'API 호출',value:num(s.range_calls),sub:'전체 '+num(s.total_calls)+'회',iconBg:'var(--red-light)',iconColor:'var(--red)'},
        {icon:'payments',label:periodLabel+' 비용',value:fmtCost(s.range_cost),sub:'전체 '+fmtCost(s.total_cost),iconBg:'#f0e6ff',iconColor:'var(--purple)'}
    ];
    var h='';cards.forEach(function(c){h+='<div class="stat-card"><div class="stat-card-icon" style="background:'+c.iconBg+';color:'+c.iconColor+'"><span class="material-icons-outlined">'+c.icon+'</span></div><div class="stat-card-info"><div class="stat-label">'+c.label+'</div><div class="stat-value">'+c.value+'</div>'+(c.sub?'<div class="stat-sub">'+c.sub+'</div>':'')+'</div></div>'});
    $('#token-stat-grid').html(h)}
function renderTokenDailyChart(days){if(!days.length)return;$('#token-daily-range').text(days[0].date+' ~ '+days[days.length-1].date);makeChart('chart-token-daily',{type:'line',data:{labels:days.map(function(d){return d.date}),datasets:[{label:'입력 토큰',data:days.map(function(d){return d.input_tokens}),borderColor:'#4f6ef7',backgroundColor:'rgba(79,110,247,0.06)',fill:true,tension:.4,borderWidth:2.5,pointRadius:0,pointHoverRadius:5,pointHoverBackgroundColor:'#4f6ef7'},{label:'출력 토큰',data:days.map(function(d){return d.output_tokens}),borderColor:'#06b6d4',backgroundColor:'transparent',fill:false,tension:.4,borderWidth:2,borderDash:[4,4],pointRadius:0,pointHoverRadius:4}]},options:chartOpts()})}
function renderTokenMonthlyChart(months,year){$('#token-monthly-label').text(year+'년');makeChart('chart-token-monthly',{type:'bar',data:{labels:months.map(function(m){return m.month+'월'}),datasets:[{label:'입력 토큰',data:months.map(function(m){return m.input_tokens}),backgroundColor:'#4f6ef7',borderRadius:6,maxBarThickness:20},{label:'출력 토큰',data:months.map(function(m){return m.output_tokens}),backgroundColor:'#06b6d4',borderRadius:6,maxBarThickness:20}]},options:chartOpts()})}
function renderTokenModelChart(models){if(!models.length){$('#token-model-legend').html('<div style="text-align:center;padding:30px;color:var(--tx3);font-size:11px">데이터 없음</div>');return}var mc=['#8b5cf6','#06b6d4','#22c55e','#f59e0b'];makeChart('chart-token-model',{type:'doughnut',data:{labels:models.map(function(m){return m.label}),datasets:[{data:models.map(function(m){return m.total_tokens}),backgroundColor:mc.slice(0,models.length),borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{display:false}}}});var lh='';models.forEach(function(m,i){lh+='<div class="feat-item"><div class="feat-dot" style="background:'+mc[i%mc.length]+'"></div><span>'+esc(m.label)+'</span><span style="margin-left:auto;font-size:10px;color:var(--tx3)">'+fmtTokens(m.total_tokens)+' ('+num(m.calls)+'회)</span><span class="feat-count">'+fmtCost(m.cost)+'</span></div>'});$('#token-model-legend').html(lh)}
function renderTokenServiceChart(services){if(!services.length){$('#token-service-legend').html('<div style="text-align:center;padding:30px;color:var(--tx3);font-size:11px">데이터 없음</div>');return}makeChart('chart-token-service',{type:'doughnut',data:{labels:services.map(function(s){return s.label}),datasets:[{data:services.map(function(s){return s.total_tokens}),backgroundColor:COLORS.slice(0,services.length),borderWidth:0,hoverOffset:6}]},options:{responsive:true,maintainAspectRatio:false,cutout:'60%',plugins:{legend:{display:false}}}});var lh='';services.forEach(function(s,i){lh+='<div class="feat-item"><div class="feat-dot" style="background:'+COLORS[i%COLORS.length]+'"></div><span>'+esc(s.label)+'</span><span style="margin-left:auto;font-size:10px;color:var(--tx3)">'+fmtTokens(s.total_tokens)+' ('+num(s.calls)+'회)</span><span class="feat-count">'+fmtCost(s.cost)+'</span></div>'});$('#token-service-legend').html(lh)}
function renderTokenUsersTable(users){$('#token-user-count-badge').text('Top '+users.length);if(!users.length){$('#token-user-tbody').html('<tr><td colspan="9" style="text-align:center;padding:30px;color:var(--tx3)">데이터 없음</td></tr>');return}var h='';users.forEach(function(u,i){var rk=i<3?'<span class="rank-medal rank-'+(i+1)+'">'+(i+1)+'</span>':'<span style="color:var(--tx3);font-size:10px">'+(i+1)+'</span>';h+='<tr><td>'+rk+'</td><td><div style="display:flex;align-items:center"><span class="user-avatar '+AV[i%3]+'">'+esc((u.display_name||'?').charAt(0))+'</span><span class="user-name">'+esc(u.display_name)+'</span></div></td><td><span class="user-id">'+esc(u.username)+'</span></td><td class="r" style="font-size:11px">'+fmtTokens(u.input_tokens)+'</td><td class="r" style="font-size:11px">'+fmtTokens(u.output_tokens)+'</td><td class="r"><span class="badge badge-blue">'+fmtTokens(u.total_tokens)+'</span></td><td class="r"><span class="model-badge model-opus">'+num(u.opus_calls)+'</span></td><td class="r"><span class="model-badge model-sonnet">'+num(u.sonnet_calls)+'</span></td><td class="r" style="font-weight:600;font-size:11px">'+fmtCost(u.cost)+'</td></tr>'});$('#token-user-tbody').html(h)}
</script>
</body>
</html>
