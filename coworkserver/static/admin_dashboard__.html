<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>{{APP_TITLE}} - 관리자 대시보드</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Noto+Sans+KR:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
<style>
:root{--bg:#f8fafc;--card:#fff;--border:#f1f5f9;--tx:#0f172a;--tx2:#64748b;--tx3:#94a3b8;--blue:#6366f1;--cyan:#06b6d4;--green:#10b981;--amber:#f59e0b;--purple:#8b5cf6;--shadow:0 1px 3px rgba(0,0,0,.04);--radius:14px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter','Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx);line-height:1.5;font-size:13px}
/* Header */
.dash-header{background:var(--card);border-bottom:1px solid var(--border);padding:12px 28px;position:sticky;top:0;z-index:10}
.dash-header-inner{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.dash-logo{display:flex;align-items:center;gap:10px}
.dash-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:15px;box-shadow:0 4px 12px rgba(99,102,241,.2)}
.dash-logo h1{font-size:14px;font-weight:700}.dash-logo p{font-size:10px;color:var(--tx3)}
.dash-controls{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.nav-tabs{display:flex;gap:2px;background:#f1f5f9;border-radius:8px;padding:2px}
.nav-tab{padding:5px 14px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;transition:all .15s;color:var(--tx2);background:transparent}
.nav-tab.active{background:var(--blue);color:#fff;box-shadow:0 2px 6px rgba(99,102,241,.25)}
.nav-tab:not(.active):hover{background:#e2e8f0}
.icon-btn{width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:var(--card);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;color:var(--tx3);transition:all .15s}
.icon-btn:hover{background:#f1f5f9;color:var(--tx)}
/* Period + Date Range */
.filter-bar{display:flex;align-items:center;gap:8px;margin-bottom:14px;flex-wrap:wrap}
.period-tabs{display:flex;gap:2px;background:#f1f5f9;border-radius:7px;padding:2px}
.period-btn{padding:5px 11px;border-radius:5px;font-size:10px;font-weight:600;border:none;cursor:pointer;transition:all .12s;color:var(--tx2);background:transparent}
.period-btn.active{background:var(--blue);color:#fff}
.period-btn:not(.active):hover{background:#e2e8f0}
.year-select{padding:4px 8px;border:1px solid var(--border);border-radius:5px;font-size:10px;font-weight:600;color:var(--tx2);background:var(--card);cursor:pointer}
/* Range Picker */
.range-picker-wrap{position:relative;display:inline-flex}
.range-btn{padding:5px 12px;border:1px solid var(--border);border-radius:7px;font-size:10px;font-weight:600;color:var(--tx2);background:var(--card);cursor:pointer;display:flex;align-items:center;gap:4px;transition:all .15s;white-space:nowrap}
.range-btn:hover{border-color:var(--blue);color:var(--blue)}
.range-btn.has-range{border-color:var(--blue);background:#eef2ff;color:var(--blue)}
.range-clear{margin-left:4px;cursor:pointer;font-size:12px;color:var(--blue);font-weight:700}
.range-dropdown{position:absolute;top:100%;right:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.15);z-index:30;padding:16px;display:none;width:580px}
/* Calendar */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cal-nav{background:none;border:none;cursor:pointer;color:var(--tx2);font-size:16px;padding:4px}
.cal-nav:hover{color:var(--blue)}
.cal-title{font-size:13px;font-weight:700;color:var(--tx)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;text-align:center}
.cal-dow{font-size:9px;font-weight:700;color:var(--tx3);padding:4px 0}
.cal-day{font-size:11px;padding:6px 2px;cursor:pointer;border-radius:6px;transition:all .1s;color:var(--tx)}
.cal-day:hover{background:#eef2ff}
.cal-day.other-month{color:#d1d5db}
.cal-day.today{font-weight:700;color:var(--blue)}
.cal-day.in-range{background:#eef2ff;border-radius:0}
.cal-day.range-start{background:var(--blue);color:#fff;border-radius:6px 0 0 6px}
.cal-day.range-end{background:var(--blue);color:#fff;border-radius:0 6px 6px 0}
.cal-day.range-start.range-end{border-radius:6px}
.cal-day.hover-end{background:rgba(99,102,241,.2);border-radius:6px}
.cal-months{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.cal-apply{margin-top:10px;display:flex;justify-content:flex-end;gap:6px}
.cal-apply button{padding:6px 16px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:none;transition:all .12s}
.cal-apply .apply-btn{background:var(--blue);color:#fff}.cal-apply .apply-btn:hover{background:#4f46e5}
.cal-apply .clear-btn{background:#f1f5f9;color:var(--tx2)}.cal-apply .clear-btn:hover{background:#e2e8f0}
/* Content */
.dash-content{max-width:1280px;margin:0 auto;padding:16px 28px 40px}
.tab-page{display:none}.tab-page.active{display:block}
/* Stat Cards */
.stat-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px}
@media(max-width:1024px){.stat-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:640px){.stat-grid{grid-template-columns:repeat(2,1fr)}}
.stat-card{background:var(--card);border-radius:var(--radius);padding:16px;border:1px solid var(--border);box-shadow:var(--shadow);transition:all .2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.06)}
.stat-icon{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;color:#fff;margin-bottom:8px}
.stat-icon .material-icons-outlined{font-size:17px}
.stat-label{font-size:10px;font-weight:600;color:var(--tx3);margin-bottom:2px}
.stat-value{font-size:24px;font-weight:800;color:var(--tx);letter-spacing:-.5px}
.stat-sub{font-size:10px;color:var(--tx3);margin-top:2px}
/* Chart */
.chart-grid{display:grid;gap:14px;margin-bottom:14px}
.chart-grid-2{grid-template-columns:1fr 1fr}
.chart-grid-3{grid-template-columns:1fr 2fr}
@media(max-width:900px){.chart-grid-2,.chart-grid-3{grid-template-columns:1fr}}
.chart-card{background:var(--card);border-radius:var(--radius);padding:18px;border:1px solid var(--border);box-shadow:var(--shadow)}
.chart-title{font-size:12px;font-weight:700;color:var(--tx);margin-bottom:2px}
.chart-subtitle{font-size:10px;color:var(--tx3);margin-bottom:12px}
.chart-canvas{position:relative;width:100%;height:240px}
/* Table */
.data-table{width:100%;border-collapse:collapse;font-size:11px}
.data-table thead th{text-align:left;padding:7px 8px;font-weight:600;color:var(--tx3);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card);font-size:10px}
.data-table thead th.r{text-align:right}
.data-table tbody tr{border-bottom:1px solid #fafbfc;transition:background .1s;cursor:pointer}
.data-table tbody tr:hover{background:#fafbfd}
.data-table td{padding:7px 8px;vertical-align:middle}
.data-table td.r{text-align:right}
.user-avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#818cf8,#a78bfa);display:inline-flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;margin-right:6px;vertical-align:middle}
.user-name{font-weight:600;color:var(--tx);font-size:11px}
.user-id{font-size:9px;color:var(--tx3)}
.badge{display:inline-block;padding:2px 7px;border-radius:8px;font-size:10px;font-weight:700}
.badge-blue{background:#eef2ff;color:var(--blue)}.badge-green{background:#ecfdf5;color:var(--green)}.badge-amber{background:#fffbeb;color:#b45309}
.rank-medal{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;color:#fff;font-size:8px;font-weight:700}
.rank-1{background:#fbbf24}.rank-2{background:#9ca3af}.rank-3{background:#b45309}
.rank-bar{height:3px;background:#f1f5f9;border-radius:2px;margin-top:3px;overflow:hidden;width:60px}
.rank-bar-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--blue),var(--purple))}
.scroll-box{max-height:380px;overflow-y:auto}
.feat-legend{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:8px}
.feat-item{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--tx2);padding:4px 6px;background:#f8fafc;border-radius:5px}
.feat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.feat-count{margin-left:auto;font-weight:700;color:var(--tx)}
/* Search */
.search-box{position:relative;margin-bottom:14px}
.search-input{width:100%;padding:9px 12px 9px 36px;border:1px solid var(--border);border-radius:8px;font-size:12px;font-family:inherit;background:var(--card);transition:border .2s}
.search-input:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--tx3);font-size:16px}
.search-results{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,.12);z-index:20;max-height:260px;overflow-y:auto;display:none;margin-top:3px}
.search-item{display:flex;align-items:center;gap:8px;padding:8px 12px;cursor:pointer;transition:background .1s;border-bottom:1px solid #fafbfc}
.search-item:hover,.search-item.search-active{background:#f0f2ff}
.search-item:last-child{border:none}
.search-empty{padding:16px;text-align:center;color:var(--tx3);font-size:11px}
/* User detail */
.user-detail-header{display:flex;align-items:center;gap:14px;margin-bottom:16px;padding:16px;background:var(--card);border-radius:var(--radius);border:1px solid var(--border)}
.ud-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#818cf8,#a78bfa);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:700;flex-shrink:0}
.ud-info h2{font-size:16px;font-weight:700;margin-bottom:1px}.ud-info p{font-size:11px;color:var(--tx3)}
.ud-back{display:inline-flex;align-items:center;gap:3px;font-size:11px;color:var(--blue);cursor:pointer;font-weight:600;margin-bottom:10px;padding:3px 0}
.ud-back:hover{text-decoration:underline}
.storage-bar{height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden;margin-top:3px}
.storage-bar-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue),var(--cyan))}
/* Loading */
.dash-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh}
.loading-spinner{width:30px;height:30px;border:3px solid #e0e7ff;border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{margin-top:8px;font-size:11px;color:var(--tx3)}
.dash-footer{text-align:center;font-size:9px;color:#cbd5e1;padding:12px 0}
</style>
</head>
<body>
<div class="dash-header"><div class="dash-header-inner">
  <div class="dash-logo"><div class="dash-logo-icon">{{APP_BRAND_ICON}}</div><div><h1>관리자 대시보드</h1><p>{{APP_TITLE}}</p></div></div>
  <div class="dash-controls">
    <div class="nav-tabs" id="nav-tabs">
      <button class="nav-tab active" data-tab="overview"><span class="material-icons-outlined" style="font-size:13px;vertical-align:-2px">dashboard</span> 전체 현황</button>
      <button class="nav-tab" data-tab="users"><span class="material-icons-outlined" style="font-size:13px;vertical-align:-2px">person_search</span> 사용자 검색</button>
      <button class="nav-tab" data-tab="storage"><span class="material-icons-outlined" style="font-size:13px;vertical-align:-2px">storage</span> 파일/스토리지</button>
    </div>
    <button class="icon-btn" id="btn-refresh" title="새로고침"><span class="material-icons-outlined" style="font-size:14px">refresh</span></button>
  </div>
</div></div>
<div class="dash-loading" id="dash-loading"><div class="loading-spinner"></div><div class="loading-text">대시보드 로딩 중...</div></div>
<div class="dash-content" id="dash-content" style="display:none">

<!-- TAB: OVERVIEW -->
<div class="tab-page active" id="page-overview">
  <div class="filter-bar" id="overview-filters">
    <div class="period-tabs" id="period-tabs"><button class="period-btn" data-p="today">오늘</button><button class="period-btn" data-p="week">이번 주</button><button class="period-btn active" data-p="month">이번 달</button><button class="period-btn" data-p="year">올해</button></div>
    <select class="year-select" id="year-select"></select>
    <div class="range-picker-wrap" id="overview-range-wrap"><button class="range-btn" id="overview-range-btn"><span class="material-icons-outlined" style="font-size:14px">date_range</span> <span class="range-label">기간 선택</span></button><div class="range-dropdown" id="overview-range-dd"></div></div>
  </div>
  <div class="stat-grid" id="stat-grid"></div>
  <div class="chart-grid chart-grid-2"><div class="chart-card"><div class="chart-title">일별 사용 추이</div><div class="chart-subtitle" id="daily-range"></div><div class="chart-canvas"><canvas id="chart-daily"></canvas></div></div><div class="chart-card"><div class="chart-title">월별 현황</div><div class="chart-subtitle" id="monthly-label"></div><div class="chart-canvas"><canvas id="chart-monthly"></canvas></div></div></div>
  <div class="chart-grid chart-grid-3" style="margin-top:14px"><div class="chart-card"><div class="chart-title">기능별 사용 비율</div><div class="chart-subtitle" id="feat-period-label"></div><div class="chart-canvas" style="height:180px"><canvas id="chart-features"></canvas></div><div class="feat-legend" id="feat-legend"></div></div><div class="chart-card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:2px"><span class="chart-title">사용자 랭킹 (Top 50)</span><span class="badge badge-blue" id="user-count-badge">0명</span></div><div class="chart-subtitle">대화 수 기준</div><div class="scroll-box"><table class="data-table"><thead><tr><th style="width:32px">#</th><th>사용자</th><th>ID</th><th class="r">대화</th><th class="r">활동</th></tr></thead><tbody id="user-tbody"></tbody></table></div></div></div>
</div>

<!-- TAB: USERS -->
<div class="tab-page" id="page-users">
  <div id="user-search-panel">
    <div class="search-box"><span class="material-icons-outlined search-icon">search</span><input type="text" class="search-input" id="user-search-input" placeholder="이름 또는 ID로 사용자 검색..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" name="dash-user-search-x"><div class="search-results" id="search-results"></div></div>
    <div id="search-hint" style="text-align:center;padding:50px 16px;color:var(--tx3)"><span class="material-icons-outlined" style="font-size:44px;color:#e2e8f0;display:block;margin-bottom:10px">person_search</span><p style="font-size:12px;font-weight:600;margin-bottom:3px">사용자를 검색하세요</p><p style="font-size:10px">이름/ID 입력 → 사용자별 상세 분석</p></div>
  </div>
  <div id="user-detail-panel" style="display:none">
    <div class="ud-back" id="ud-back"><span class="material-icons-outlined" style="font-size:14px">arrow_back</span> 검색으로</div>
    <div class="filter-bar" id="ud-filters">
      <div class="period-tabs" id="ud-period-tabs"><button class="period-btn" data-p="today">오늘</button><button class="period-btn" data-p="week">이번 주</button><button class="period-btn active" data-p="month">이번 달</button><button class="period-btn" data-p="year">올해</button></div>
      <div class="range-picker-wrap" id="ud-range-wrap"><button class="range-btn" id="ud-range-btn"><span class="material-icons-outlined" style="font-size:14px">date_range</span> <span class="range-label">기간 선택</span></button><div class="range-dropdown" id="ud-range-dd"></div></div>
    </div>
    <div class="user-detail-header" id="ud-header"></div>
    <div class="stat-grid" id="ud-stats" style="grid-template-columns:repeat(4,1fr)"></div>
    <div class="chart-grid chart-grid-2"><div class="chart-card"><div class="chart-title">일별 대화 추이</div><div class="chart-subtitle" id="ud-daily-range"></div><div class="chart-canvas"><canvas id="chart-ud-daily"></canvas></div></div><div class="chart-card"><div class="chart-title">월별 대화 현황</div><div class="chart-subtitle" id="ud-monthly-label"></div><div class="chart-canvas"><canvas id="chart-ud-monthly"></canvas></div></div></div>
    <div class="chart-card" style="margin-top:14px"><div class="chart-title">파일 사용량</div><div id="ud-file-stats" style="padding:6px 0"></div></div>
  </div>
</div>

<!-- TAB: STORAGE -->
<div class="tab-page" id="page-storage"></div>
<div class="dash-footer">{{APP_TITLE}} Administration Dashboard</div>
</div>

<script>
var BASE='{{BASE_URL}}',CI={},COLORS=['#6366f1','#06b6d4','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#14b8a6'];
var currentPeriod='month',currentYear=new Date().getFullYear(),searchTimer=null;
var overviewRange={start:null,end:null},udRange={start:null,end:null},udUsername='';
function api(p){return $.getJSON(BASE+p)}
function esc(s){return $('<span>').text(s).html()}
function num(n){return(n||0).toLocaleString()}
function fmtDate(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function fmtDateKr(d){return(d.getMonth()+1)+'월 '+d.getDate()+'일'}
function makeChart(id,cfg){if(CI[id])CI[id].destroy();CI[id]=new Chart(document.getElementById(id).getContext('2d'),cfg)}
function chartOpts(h){return{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'top',labels:{usePointStyle:true,pointStyle:'circle',padding:12,font:{size:9,weight:'600'}}}},scales:{x:{grid:{display:false},ticks:{font:{size:8},color:'#94a3b8',maxTicksLimit:12}},y:{grid:{color:'#f1f5f9'},ticks:{font:{size:8},color:'#94a3b8'},beginAtZero:true}}}}
function dateParams(range){return range.start&&range.end?'&start_date='+fmtDate(range.start)+'&end_date='+fmtDate(range.end):''}

// =================== RANGE CALENDAR ===================
function RangePicker(wrapId,onApply){
    var self=this;this.wrap=$('#'+wrapId);this.dd=this.wrap.find('.range-dropdown');this.btn=this.wrap.find('.range-btn');this.onApply=onApply;
    this.start=null;this.end=null;this.selecting='start';this.viewMonth=new Date().getMonth();this.viewYear=new Date().getFullYear();
    this.btn.on('click',function(e){e.stopPropagation();self.dd.is(':visible')?self.dd.hide():(self.render(),self.dd.show())});
    // 드롭다운 내부 클릭 시 닫히지 않도록 전파 차단
    this.dd.on('click',function(e){e.stopPropagation()});
    $(document).on('click',function(e){if(!$(e.target).closest('#'+wrapId).length)self.dd.hide()});
}
RangePicker.prototype.render=function(){
    var self=this,m1=this.viewMonth,y1=this.viewYear,m2=m1+1,y2=y1;if(m2>11){m2=0;y2++}
    var statusText='';
    if(this.start&&!this.end) statusText='<div style="text-align:center;font-size:10px;color:var(--blue);font-weight:600;padding:6px 0;background:#eef2ff;border-radius:6px;margin-bottom:8px">시작일: '+fmtDateKr(this.start)+' — 종료일을 선택하세요</div>';
    else if(this.start&&this.end) statusText='<div style="text-align:center;font-size:10px;color:var(--blue);font-weight:600;padding:6px 0;background:#eef2ff;border-radius:6px;margin-bottom:8px">'+fmtDateKr(this.start)+' ~ '+fmtDateKr(this.end)+' ('+Math.round((this.end-this.start)/86400000+1)+'일)</div>';
    else statusText='<div style="text-align:center;font-size:10px;color:var(--tx3);padding:6px 0;margin-bottom:8px">시작일을 선택하세요</div>';
    var h='<div class="cal-header"><button class="cal-nav" data-dir="prev">◀</button><span class="cal-title">'+y1+'년 '+(m1+1)+'월 — '+y2+'년 '+(m2+1)+'월</span><button class="cal-nav" data-dir="next">▶</button></div>';
    h+=statusText;
    h+='<div class="cal-months"><div>'+this.renderMonth(y1,m1)+'</div><div>'+this.renderMonth(y2,m2)+'</div></div>';
    h+='<div class="cal-apply"><button class="clear-btn cal-action" data-act="clear">초기화</button><button class="apply-btn cal-action" data-act="apply"'+(this.start&&this.end?'':' disabled style="opacity:.4;cursor:default"')+'>적용</button></div>';
    this.dd.html(h);
    // 이벤트 바인딩
    this.dd.off('click.cal').on('click.cal','.cal-nav',function(e){
        e.stopPropagation();
        if($(this).data('dir')==='prev'){self.viewMonth--;if(self.viewMonth<0){self.viewMonth=11;self.viewYear--}}
        else{self.viewMonth++;if(self.viewMonth>11){self.viewMonth=0;self.viewYear++}}
        self.render();
    }).on('click.cal','.cal-day[data-d]',function(e){
        e.stopPropagation();
        var d=new Date($(this).data('d'));
        if(self.selecting==='start'){self.start=d;self.end=null;self.selecting='end'}
        else{if(d>=self.start){self.end=d}else{self.end=self.start;self.start=d}self.selecting='start'}
        self.render();
    }).on('click.cal','.cal-action',function(e){
        e.stopPropagation();
        if($(this).data('act')==='clear'){self.start=null;self.end=null;self.selecting='start';self.updateBtn();self.render();self.onApply(null,null)}
        else if($(this).data('act')==='apply'&&self.start&&self.end){self.dd.hide();self.updateBtn();self.onApply(self.start,self.end)}
    });
    // 호버 미리보기: 시작일만 선택된 상태에서만 활성화
    this.dd.off('mouseenter.cal');
    if(this.start&&!this.end){
        this.dd.on('mouseenter.cal','.cal-day[data-d]',function(){
            var hd=new Date($(this).data('d'));
            self.dd.find('.cal-day[data-d]').each(function(){
                var cd=new Date($(this).data('d'));$(this).removeClass('in-range hover-end');
                if(hd>=self.start){if(cd>self.start&&cd<hd)$(this).addClass('in-range');if(cd.getTime()===hd.getTime())$(this).addClass('hover-end')}
                else{if(cd<self.start&&cd>hd)$(this).addClass('in-range');if(cd.getTime()===hd.getTime())$(this).addClass('hover-end')}
            });
        });
    }
};
RangePicker.prototype.renderMonth=function(y,m){
    var dows=['일','월','화','수','목','금','토'];
    var h='<div class="cal-grid">';dows.forEach(function(d){h+='<div class="cal-dow">'+d+'</div>'});
    var first=new Date(y,m,1),last=new Date(y,m+1,0),startDow=first.getDay(),today=new Date();today.setHours(0,0,0,0);
    for(var i=0;i<startDow;i++){var pd=new Date(y,m,-startDow+i+1);h+=this.dayCell(pd,true)}
    for(var d=1;d<=last.getDate();d++){var dt=new Date(y,m,d);h+=this.dayCell(dt,false)}
    var remain=7-(startDow+last.getDate())%7;if(remain<7)for(var i=1;i<=remain;i++){var nd=new Date(y,m+1,i);h+=this.dayCell(nd,true)}
    h+='</div>';return h;
};
RangePicker.prototype.dayCell=function(dt,otherMonth){
    var cls='cal-day',today=new Date();today.setHours(0,0,0,0);
    if(otherMonth)cls+=' other-month';if(dt.getTime()===today.getTime())cls+=' today';
    if(this.start&&this.end){var t=dt.getTime();if(t===this.start.getTime())cls+=' range-start';if(t===this.end.getTime())cls+=' range-end';if(t>this.start.getTime()&&t<this.end.getTime())cls+=' in-range'}
    else if(this.start&&dt.getTime()===this.start.getTime())cls+=' range-start range-end';
    return'<div class="'+cls+'" data-d="'+fmtDate(dt)+'">'+dt.getDate()+'</div>';
};
RangePicker.prototype.updateBtn=function(){
    if(this.start&&this.end){this.btn.addClass('has-range');this.btn.find('.range-label').html(fmtDateKr(this.start)+' ~ '+fmtDateKr(this.end)+' <span class="range-clear" onclick="event.stopPropagation()">✕</span>');
        var self=this;this.btn.find('.range-clear').on('click',function(){self.start=null;self.end=null;self.updateBtn();self.onApply(null,null)})}
    else{this.btn.removeClass('has-range');this.btn.find('.range-label').text('기간 선택')}
};
RangePicker.prototype.setRange=function(s,e){this.start=s;this.end=e;this.updateBtn()};

// =================== INIT ===================
var overviewPicker,udPicker;
$(function(){
    var $ys=$('#year-select');for(var y=2024;y<=2028;y++)$ys.append('<option value="'+y+'"'+(y===currentYear?' selected':'')+'>'+y+'년</option>');
    $ys.on('change',function(){currentYear=+$(this).val();loadOverview()});
    $('#period-tabs').on('click','.period-btn',function(){currentPeriod=$(this).data('p');$('#period-tabs .period-btn').removeClass('active');$(this).addClass('active');overviewRange={start:null,end:null};overviewPicker.setRange(null,null);loadOverview()});
    $('#nav-tabs').on('click','.nav-tab',function(){var tab=$(this).data('tab');$('#nav-tabs .nav-tab').removeClass('active');$(this).addClass('active');$('.tab-page').removeClass('active');$('#page-'+tab).addClass('active');if(tab==='storage')loadStorage()});
    $('#btn-refresh').on('click',function(){var a=$('#nav-tabs .nav-tab.active').data('tab');if(a==='overview')loadOverview();else if(a==='storage')loadStorage();else if(a==='users'&&udUsername)loadUserDetail(udUsername)});
    // Search with keyboard navigation
    var searchIdx=-1;
    $('#user-search-input').on('input',function(){
        clearTimeout(searchTimer);searchIdx=-1;
        var q=$(this).val().trim();
        if(q.length<1){$('#search-results').hide();return}
        searchTimer=setTimeout(function(){searchUsers(q)},300);
    }).on('focus',function(){
        if($('#search-results .search-item').length)$('#search-results').show();
    }).on('keydown',function(e){
        var $items=$('#search-results .search-item');
        if(!$items.length||!$('#search-results').is(':visible')) return;
        if(e.key==='ArrowDown'||e.keyCode===40){
            e.preventDefault();searchIdx=Math.min(searchIdx+1,$items.length-1);
            $items.removeClass('search-active');$items.eq(searchIdx).addClass('search-active');
            $items.eq(searchIdx)[0].scrollIntoView({block:'nearest'});
        }else if(e.key==='ArrowUp'||e.keyCode===38){
            e.preventDefault();searchIdx=Math.max(searchIdx-1,0);
            $items.removeClass('search-active');$items.eq(searchIdx).addClass('search-active');
            $items.eq(searchIdx)[0].scrollIntoView({block:'nearest'});
        }else if(e.key==='Enter'||e.keyCode===13){
            e.preventDefault();
            if(searchIdx>=0&&searchIdx<$items.length){$items.eq(searchIdx).trigger('click')}
            else if($items.length===1){$items.eq(0).trigger('click')}
        }else if(e.key==='Escape'||e.keyCode===27){
            $('#search-results').hide();searchIdx=-1;
        }
    });
    // 마우스 오버 시 키보드 인덱스 동기화
    $(document).on('mouseenter','.search-item',function(){
        searchIdx=$(this).index();$('.search-item').removeClass('search-active');$(this).addClass('search-active');
    });
    $(document).on('click',function(e){if(!$(e.target).closest('.search-box').length)$('#search-results').hide()});
    $('#ud-back').on('click',function(){$('#user-detail-panel').hide();$('#user-search-panel').show()});
    // User detail period
    $('#ud-period-tabs').on('click','.period-btn',function(){$('#ud-period-tabs .period-btn').removeClass('active');$(this).addClass('active');udRange={start:null,end:null};udPicker.setRange(null,null);if(udUsername)loadUserDetail(udUsername)});
    // Range Pickers
    overviewPicker=new RangePicker('overview-range-wrap',function(s,e){overviewRange.start=s;overviewRange.end=e;if(s&&e){$('#period-tabs .period-btn').removeClass('active')}loadOverview()});
    udPicker=new RangePicker('ud-range-wrap',function(s,e){udRange.start=s;udRange.end=e;if(s&&e){$('#ud-period-tabs .period-btn').removeClass('active')}if(udUsername)loadUserDetail(udUsername)});
    loadOverview();
});

// =================== OVERVIEW ===================
function loadOverview(){
    $('#dash-loading').show();$('#dash-content').hide();
    var dp;
    if(overviewRange.start&&overviewRange.end){dp=dateParams(overviewRange)}
    else{var pr=periodToRange(currentPeriod);dp='&start_date='+fmtDate(pr.start)+'&end_date='+fmtDate(pr.end)}
    var pp='&period='+currentPeriod;
    $.when(api('/api/admin/dashboard/summary?_=1'+dp),api('/api/admin/dashboard/daily?days=30'+dp),api('/api/admin/dashboard/monthly?year='+currentYear),api('/api/admin/dashboard/users?_=1'+pp+dp),api('/api/admin/dashboard/features?_=1'+pp+dp)
    ).then(function(s,d,m,u,f){renderSummary(s[0]);renderDailyChart(d[0].days||[]);renderMonthlyChart(m[0].months||[],currentYear);renderFeaturesChart(f[0].features||[]);renderUsersTable(u[0].users||[]);$('#dash-loading').hide();$('#dash-content').show()
    }).fail(function(){$('#dash-loading').html('<div style="text-align:center;padding:30px"><span class="material-icons-outlined" style="font-size:40px;color:#ef4444">error_outline</span><p style="margin-top:8px;color:var(--tx2);font-size:12px">데이터 로드 실패</p><button onclick="loadOverview()" style="margin-top:8px;padding:6px 20px;background:var(--blue);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:11px">다시 시도</button></div>')});
}
function renderSummary(s){
    var periodLabel=overviewRange.start?fmtDateKr(overviewRange.start)+' ~ '+fmtDateKr(overviewRange.end):($('#period-tabs .period-btn.active').text()||'이번 달');
    var cards=[
        {icon:'group',label:'전체 사용자',value:s.total_users,sub:'오늘: '+num(s.today_users)+'명',bg:'linear-gradient(135deg,#6366f1,#4f46e5)'},
        {icon:'chat',label:'전체 대화',value:s.total_chats,sub:'오늘: '+num(s.today_chats)+'건',bg:'linear-gradient(135deg,#06b6d4,#0891b2)'},
        {icon:'bolt',label:'AI 작업',value:s.total_tasks,sub:'오늘: '+num(s.today_tasks)+'건',bg:'linear-gradient(135deg,#10b981,#059669)'},
        {icon:'folder_special',label:'프로젝트',value:s.total_projects,sub:'',bg:'linear-gradient(135deg,#f59e0b,#d97706)'},
        {icon:'psychology',label:'스킬',value:s.total_skills,sub:'',bg:'linear-gradient(135deg,#8b5cf6,#7c3aed)'}
    ];
    // 항상 기간 선택 카드 표시
    cards.splice(2,0,{icon:'date_range',label:periodLabel+' 대화',value:s.range_chats,sub:'사용자: '+num(s.range_users)+'명',bg:'linear-gradient(135deg,#ec4899,#be185d)'});
    $('#stat-grid').css('grid-template-columns','repeat(6,1fr)');
    var h='';cards.forEach(function(c){h+='<div class="stat-card"><div class="stat-icon" style="background:'+c.bg+'"><span class="material-icons-outlined">'+c.icon+'</span></div><div class="stat-label">'+c.label+'</div><div class="stat-value">'+num(c.value)+'</div>'+(c.sub?'<div class="stat-sub">'+c.sub+'</div>':'')+'</div>'});$('#stat-grid').html(h);
}
function renderDailyChart(days){if(!days.length)return;$('#daily-range').text(days[0].date+' ~ '+days[days.length-1].date);makeChart('chart-daily',{type:'line',data:{labels:days.map(function(d){return d.date}),datasets:[{label:'대화',data:days.map(function(d){return d.chats}),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.08)',fill:true,tension:.4,borderWidth:2,pointRadius:0,pointHoverRadius:3},{label:'사용자',data:days.map(function(d){return d.users}),borderColor:'#06b6d4',backgroundColor:'rgba(6,182,212,0.08)',fill:true,tension:.4,borderWidth:2,pointRadius:0,pointHoverRadius:3}]},options:chartOpts()})}
function renderMonthlyChart(months,year){$('#monthly-label').text(year+'년');makeChart('chart-monthly',{type:'bar',data:{labels:months.map(function(m){return m.month+'월'}),datasets:[{label:'대화',data:months.map(function(m){return m.chats}),backgroundColor:'#6366f1',borderRadius:4,maxBarThickness:16},{label:'작업',data:months.map(function(m){return m.tasks}),backgroundColor:'#06b6d4',borderRadius:4,maxBarThickness:16},{label:'사용자',data:months.map(function(m){return m.users}),backgroundColor:'#10b981',borderRadius:4,maxBarThickness:16}]},options:chartOpts()})}
function renderFeaturesChart(features){var pl={today:'오늘',week:'이번 주',month:'이번 달',year:'올해'};$('#feat-period-label').text(overviewRange.start?fmtDateKr(overviewRange.start)+'~'+fmtDateKr(overviewRange.end):(pl[currentPeriod]||''));if(!features.length){$('#feat-legend').html('<div style="text-align:center;padding:24px;color:var(--tx3);font-size:10px">데이터 없음</div>');return}makeChart('chart-features',{type:'doughnut',data:{labels:features.map(function(f){return f.name}),datasets:[{data:features.map(function(f){return f.count}),backgroundColor:COLORS.slice(0,features.length),borderWidth:0,hoverOffset:4}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{display:false}}}});var lh='';features.forEach(function(f,i){lh+='<div class="feat-item"><div class="feat-dot" style="background:'+COLORS[i%COLORS.length]+'"></div><span>'+esc(f.name)+'</span><span class="feat-count">'+num(f.count)+'</span></div>'});$('#feat-legend').html(lh)}
function renderUsersTable(users){$('#user-count-badge').text(users.length+'명');if(!users.length){$('#user-tbody').html('<tr><td colspan="5" style="text-align:center;padding:24px;color:var(--tx3)">데이터 없음</td></tr>');return}var max=users[0].chat_count||1,h='';users.forEach(function(u,i){var pct=Math.round((u.chat_count/max)*100);var rk=i<3?'<span class="rank-medal rank-'+(i+1)+'">'+(i+1)+'</span>':'<span style="color:var(--tx3);font-size:9px">'+(i+1)+'</span>';var la=u.last_active?new Date(u.last_active).toLocaleDateString('ko-KR',{month:'short',day:'numeric'}):'-';h+='<tr onclick="selectUser(\''+esc(u.username)+'\')"><td>'+rk+'</td><td><div style="display:flex;align-items:center"><span class="user-avatar">'+esc((u.display_name||'?').charAt(0))+'</span><div><div class="user-name">'+esc(u.display_name)+'</div><div class="rank-bar"><div class="rank-bar-fill" style="width:'+pct+'%"></div></div></div></div></td><td><span class="user-id">'+esc(u.username)+'</span></td><td class="r"><span class="badge badge-blue">'+num(u.chat_count)+'</span></td><td class="r" style="font-size:9px;color:var(--tx3)">'+la+'</td></tr>'});$('#user-tbody').html(h)}

// =================== USERS ===================
function searchUsers(q){api('/api/admin/dashboard/search-users?q='+encodeURIComponent(q)).then(function(d){var $r=$('#search-results');$r.empty();if(!d.users||!d.users.length){$r.html('<div class="search-empty">검색 결과 없음</div>').show();return}d.users.forEach(function(u){$r.append('<div class="search-item" onclick="selectUser(\''+esc(u.username)+'\')"><span class="user-avatar" style="width:28px;height:28px;font-size:10px">'+esc((u.name||u.username||'?').charAt(0))+'</span><div><div style="font-weight:600;font-size:11px">'+esc(u.name||u.username)+'</div><div style="font-size:9px;color:var(--tx3)">'+esc(u.username)+(u.dept?' · '+esc(u.dept):'')+'</div></div></div>')});$r.show()})}
function selectUser(username){$('#search-results').hide();udUsername=username;$('#nav-tabs .nav-tab').removeClass('active');$('#nav-tabs .nav-tab[data-tab="users"]').addClass('active');$('.tab-page').removeClass('active');$('#page-users').addClass('active');$('#user-search-panel').hide();$('#user-detail-panel').show();loadUserDetail(username)}
function periodToRange(period){
    var now=new Date(),s,e=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    if(period==='today'){s=new Date(e)}
    else if(period==='week'){s=new Date(e);s.setDate(s.getDate()-6)}
    else if(period==='month'){s=new Date(now.getFullYear(),now.getMonth(),1)}
    else if(period==='year'){s=new Date(now.getFullYear(),0,1)}
    else{s=new Date(now.getFullYear(),now.getMonth(),1)}
    return{start:s,end:e};
}
function loadUserDetail(username){
    var dp;
    if(udRange.start&&udRange.end){dp=dateParams(udRange)}
    else{var pp=$('#ud-period-tabs .period-btn.active').data('p')||'month';var pr=periodToRange(pp);dp='&start_date='+fmtDate(pr.start)+'&end_date='+fmtDate(pr.end)}
    var periodLabel=$('#ud-period-tabs .period-btn.active').text()||'이번 달';
    if(udRange.start)periodLabel=fmtDateKr(udRange.start)+' ~ '+fmtDateKr(udRange.end);
    $('#ud-header').html('<div style="text-align:center;padding:16px;width:100%"><div class="loading-spinner" style="margin:0 auto"></div></div>');$('#ud-stats').empty();
    api('/api/admin/dashboard/user-detail?username='+encodeURIComponent(username)+dp).then(function(d){
        var u=d.user,s=d.stats;
        $('#ud-header').html('<div class="ud-avatar">'+esc((u.name||'?').charAt(0))+'</div><div class="ud-info"><h2>'+esc(u.name)+'</h2><p>'+esc(u.username)+(u.dept?' · '+esc(u.dept):'')+(u.role?' · <span class="badge badge-amber">'+esc(u.role)+'</span>':'')+'</p></div><div style="margin-left:auto;text-align:right"><div style="font-size:9px;color:var(--tx3)">첫 사용</div><div style="font-size:11px;font-weight:600">'+(s.first_chat?new Date(s.first_chat).toLocaleDateString('ko-KR'):'-')+'</div></div>');
        var sc=[
            {icon:'chat',label:'전체 대화',value:s.total_chats,bg:'linear-gradient(135deg,#6366f1,#4f46e5)'},
            {icon:'today',label:'오늘',value:s.today_chats,bg:'linear-gradient(135deg,#06b6d4,#0891b2)'},
            {icon:'date_range',label:periodLabel,value:s.range_chats,bg:'linear-gradient(135deg,#ec4899,#be185d)'},
            {icon:'folder',label:'프로젝트',value:s.project_count,bg:'linear-gradient(135deg,#f59e0b,#d97706)'}
        ];
        var sh='';sc.forEach(function(c){sh+='<div class="stat-card"><div class="stat-icon" style="background:'+c.bg+'"><span class="material-icons-outlined">'+c.icon+'</span></div><div class="stat-label">'+c.label+'</div><div class="stat-value">'+num(c.value)+'</div></div>'});$('#ud-stats').html(sh);
        var days=d.daily||[];if(days.length){$('#ud-daily-range').text(days[0].date+' ~ '+days[days.length-1].date);makeChart('chart-ud-daily',{type:'line',data:{labels:days.map(function(x){return x.date}),datasets:[{label:'대화',data:days.map(function(x){return x.chats}),borderColor:'#6366f1',backgroundColor:'rgba(99,102,241,0.1)',fill:true,tension:.4,borderWidth:2,pointRadius:0}]},options:chartOpts()})}
        var months=d.monthly||[];$('#ud-monthly-label').text(new Date().getFullYear()+'년');makeChart('chart-ud-monthly',{type:'bar',data:{labels:months.map(function(x){return x.month+'월'}),datasets:[{label:'대화',data:months.map(function(x){return x.chats}),backgroundColor:'#6366f1',borderRadius:4,maxBarThickness:18}]},options:chartOpts()});
        var fs=d.file_stats;$('#ud-file-stats').html('<div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap"><div><span style="font-size:10px;color:var(--tx3)">파일 수</span><div style="font-size:18px;font-weight:800">'+num(fs.total_files)+'<span style="font-size:11px;color:var(--tx3)"> 개</span></div></div><div><span style="font-size:10px;color:var(--tx3)">전체 용량</span><div style="font-size:18px;font-weight:800">'+esc(fs.total_size_fmt)+'</div></div><div style="flex:1;min-width:160px"><span style="font-size:10px;color:var(--tx3)">마지막 활동</span><div style="font-size:12px;font-weight:600">'+(s.last_chat?new Date(s.last_chat).toLocaleString('ko-KR'):'-')+'</div></div></div>')});
}

// =================== STORAGE ===================
function loadStorage(){$('#page-storage').html('<div class="dash-loading" style="height:240px"><div class="loading-spinner"></div><div class="loading-text">스토리지 분석 중...</div></div>');api('/api/admin/dashboard/storage').then(function(d){var h='<div class="stat-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px">';h+='<div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#6366f1,#4f46e5)"><span class="material-icons-outlined">storage</span></div><div class="stat-label">전체 용량</div><div class="stat-value">'+esc(d.total_size_fmt)+'</div></div>';h+='<div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#06b6d4,#0891b2)"><span class="material-icons-outlined">description</span></div><div class="stat-label">전체 파일</div><div class="stat-value">'+num(d.total_files)+'</div></div>';h+='<div class="stat-card"><div class="stat-icon" style="background:linear-gradient(135deg,#10b981,#059669)"><span class="material-icons-outlined">people</span></div><div class="stat-label">사용자</div><div class="stat-value">'+num(d.users.length)+'</div></div></div>';h+='<div class="chart-card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px"><span class="chart-title">사용자별 스토리지</span><span class="badge badge-blue">'+d.users.length+'명</span></div><div class="scroll-box" style="max-height:460px"><table class="data-table"><thead><tr><th style="width:32px">#</th><th>사용자</th><th>ID</th><th class="r">파일</th><th class="r">용량</th><th style="width:120px">비율</th></tr></thead><tbody>';var mx=d.users.length?d.users[0].size:1;d.users.forEach(function(u,i){var pct=mx>0?Math.round((u.size/mx)*100):0;var tp=d.total_size>0?(u.size/d.total_size*100).toFixed(1):'0';var rk=i<3?'<span class="rank-medal rank-'+(i+1)+'">'+(i+1)+'</span>':'<span style="color:var(--tx3);font-size:9px">'+(i+1)+'</span>';h+='<tr onclick="selectUser(\''+esc(u.username)+'\')"><td>'+rk+'</td><td><div style="display:flex;align-items:center"><span class="user-avatar">'+esc((u.display_name||'?').charAt(0))+'</span><span class="user-name">'+esc(u.display_name)+'</span></div></td><td><span class="user-id">'+esc(u.username)+'</span></td><td class="r"><span class="badge badge-blue">'+num(u.files)+'</span></td><td class="r" style="font-weight:600;font-size:10px">'+esc(u.size_fmt)+'</td><td><div style="display:flex;align-items:center;gap:4px"><div class="storage-bar" style="flex:1"><div class="storage-bar-fill" style="width:'+pct+'%"></div></div><span style="font-size:8px;color:var(--tx3);width:28px;text-align:right">'+tp+'%</span></div></td></tr>'});h+='</tbody></table></div></div>';$('#page-storage').html(h)}).fail(function(){$('#page-storage').html('<div style="text-align:center;padding:50px;color:var(--tx3);font-size:12px">스토리지 정보를 불러올 수 없습니다</div>')})}
</script>
</body>
</html>
